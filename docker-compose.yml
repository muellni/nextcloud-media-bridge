version: '3.8'

services:
  nextcloud-media-bridge:
    build: .
    container_name: nextcloud-media-bridge
    environment:
      - NEXTCLOUD_BASE_URL=${NEXTCLOUD_BASE_URL}
      - NEXTCLOUD_BASE_PATH=${NEXTCLOUD_BASE_PATH}
      - NEXTCLOUD_USERNAME=${NEXTCLOUD_USERNAME}
      - NEXTCLOUD_PASSWORD=${NEXTCLOUD_PASSWORD}
      - MATRIX_HOMESERVER_URL=${MATRIX_HOMESERVER_URL}
      - MATRIX_HOMESERVER_DOMAIN=${MATRIX_HOMESERVER_DOMAIN}
      - MATRIX_ROOMS=${MATRIX_ROOMS}
      - MATRIX_ROOM_NAME_MAP=${MATRIX_ROOM_NAME_MAP}
      - MATRIX_REDACT_ORIGINAL=${MATRIX_REDACT_ORIGINAL}
      - MATRIX_APP_REGISTRATION_PATH=${MATRIX_APP_REGISTRATION_PATH}
      - MATRIX_APP_HOST=${MATRIX_APP_HOST}
      - MATRIX_APP_PORT=${MATRIX_APP_PORT}
      - MEDIA_PROXY_SERVER_NAME=${MEDIA_PROXY_SERVER_NAME}
      - MEDIA_PROXY_LISTEN_ADDRESS=${MEDIA_PROXY_LISTEN_ADDRESS}
      - MEDIA_PROXY_LISTEN_PORT=${MEDIA_PROXY_LISTEN_PORT}
      - MEDIA_PROXY_TLS_CERT=${MEDIA_PROXY_TLS_CERT}
      - MEDIA_PROXY_TLS_KEY=${MEDIA_PROXY_TLS_KEY}
      - MEDIA_PROXY_SERVER_KEY=${MEDIA_PROXY_SERVER_KEY}
      - MEDIA_PROXY_HMAC_SECRET=${MEDIA_PROXY_HMAC_SECRET}
      - ENCRYPTION_ENABLED=${ENCRYPTION_ENABLED:-false}
      - ENCRYPTION_PICKLE_KEY=${ENCRYPTION_PICKLE_KEY}
      - ENCRYPTION_DATABASE_PATH=/data/crypto.db
    volumes:
      - ./config:/app/config
      - ./data:/data
    ports:
      - "${MATRIX_APP_PORT}:${MATRIX_APP_PORT}"
      - "${MEDIA_PROXY_LISTEN_PORT}:${MEDIA_PROXY_LISTEN_PORT}"